# Generated by Django 5.0.3 on 2025-08-06 00:14

from django.db import migrations, models


def cleanup_duplicate_attendance_before_constraint(apps, schema_editor):
    """
    unique ì œì•½ ì¡°ê±´ ìƒì„± ì „ì— ì¤‘ë³µ ë°ì´í„°ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
    Railway ì½˜ì†” ì ‘ì† ë¶ˆê°€ ì‹œë¥¼ ìœ„í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ ì •ë¦¬ ë¡œì§
    """
    ClinicAttendance = apps.get_model('core', 'ClinicAttendance')
    
    print("ğŸ” [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ì¶œì„ ë°ì´í„° ì •ë¦¬ ì‹œì‘...")
    
    # 1. ë¹„í™œì„±í™”ëœ ë°ì´í„° ì‚­ì œ
    inactive_count = ClinicAttendance.objects.filter(is_active=False).count()
    if inactive_count > 0:
        print(f"ğŸ“Š [ë§ˆì´ê·¸ë ˆì´ì…˜] ë¹„í™œì„±í™”ëœ ë°ì´í„° {inactive_count}ê°œ ì‚­ì œ ì¤‘...")
        ClinicAttendance.objects.filter(is_active=False).delete()
    
    # 2. ê°„ë‹¨í•œ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ - ORM ì‚¬ìš©
    from collections import defaultdict
    
    # ëª¨ë“  ì¶œì„ ë°ì´í„°ë¥¼ (clinic_id, student_id) ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
    all_attendances = ClinicAttendance.objects.all().order_by('clinic_id', 'student_id', 'created_at')
    grouped = defaultdict(list)
    
    for attendance in all_attendances:
        key = (attendance.clinic_id, attendance.student_id)
        grouped[key].append(attendance)
    
    total_deleted = 0
    for key, attendances in grouped.items():
        if len(attendances) > 1:
            # ê°€ì¥ ìµœê·¼ ê²ƒë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
            to_keep = attendances[-1]  # ê°€ì¥ ìµœê·¼ ê²ƒ
            to_delete = attendances[:-1]  # ë‚˜ë¨¸ì§€
            
            print(f"ğŸ“Š [ë§ˆì´ê·¸ë ˆì´ì…˜] í´ë¦¬ë‹‰ {key[0]}, í•™ìƒ {key[1]}: {len(to_delete)}ê°œ ì¤‘ë³µ ì‚­ì œ")
            
            for attendance in to_delete:
                attendance.delete()
                total_deleted += 1
    
    if total_deleted > 0:
        print(f"âœ… [ë§ˆì´ê·¸ë ˆì´ì…˜] {total_deleted}ê°œ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ")
    else:
        print("âœ… [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤")
    
    print("ğŸ‰ [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!")


def reverse_cleanup_duplicate_attendance(apps, schema_editor):
    """ì—­ë°©í–¥ ë§ˆì´ê·¸ë ˆì´ì…˜ - ì‹¤ì œë¡œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ ì¶œë ¥"""
    print("âš ï¸ [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0030_alter_clinicattendance_date"),
    ]

    operations = [
        # ğŸš¨ ì¤‘ìš”: unique ì œì•½ ì¡°ê±´ ìƒì„± ì „ì— ì¤‘ë³µ ë°ì´í„°ë¥¼ ë¨¼ì € ì •ë¦¬
        migrations.RunPython(
            cleanup_duplicate_attendance_before_constraint,
            reverse_cleanup_duplicate_attendance,
        ),
        # ë¨¼ì € ê¸°ì¡´ unique_together ì œê±° (date í•„ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŒ)
        migrations.AlterUniqueTogether(
            name="clinicattendance",
            unique_together=set(),
        ),
        # ê¸°ì¡´ ì¸ë±ìŠ¤ë“¤ ì œê±°
        migrations.RemoveIndex(
            model_name="clinicattendance",
            name="core_clinic_student_ebaed1_idx",
        ),
        migrations.RemoveIndex(
            model_name="clinicattendance",
            name="core_clinic_clinic__529a2b_idx",
        ),
        # ê¸°ì¡´ date í•„ë“œ ì œê±°
        migrations.RemoveField(
            model_name="clinicattendance",
            name="date",
        ),
        # ìƒˆ í•„ë“œë“¤ ì¶”ê°€
        migrations.AddField(
            model_name="clinicattendance",
            name="actual_attendance_date",
            field=models.DateField(
                blank=True,
                help_text="ì‹¤ì œë¡œ ì¶œì„ì„ ì²´í¬í•œ ë‚ ì§œ. ì¶œì„ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ë•Œë§Œ ì„¤ì •ë¨.",
                null=True,
                verbose_name="ì‹¤ì œ ì¶œì„ ì²´í¬ ë‚ ì§œ",
            ),
        ),
        migrations.AddField(
            model_name="clinicattendance",
            name="expected_clinic_date",
            field=models.DateField(
                default="2025-01-01",
                help_text="í•´ë‹¹ ì£¼ì—ì„œ í´ë¦¬ë‹‰ì´ ì—´ë¦¬ëŠ” ì˜ˆìƒ ë‚ ì§œ (í´ë¦¬ë‹‰ ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë¨)",
                verbose_name="ì˜ˆìƒ í´ë¦¬ë‹‰ ë‚ ì§œ",
            ),
        ),
        migrations.AddField(
            model_name="clinicattendance",
            name="reservation_date",
            field=models.DateField(
                default="2025-01-01",
                help_text="í´ë¦¬ë‹‰ ì˜ˆì•½ì„ ìƒì„±í•œ ë‚ ì§œ (ì–¸ì œ ì˜ˆì•½í–ˆëŠ”ì§€)",
                verbose_name="ì˜ˆì•½ ìƒì„± ë‚ ì§œ",
            ),
        ),
        # ìƒˆ í•„ë“œë“¤ì´ ì¶”ê°€ëœ í›„ì— unique_together ë³€ê²½
        migrations.AlterUniqueTogether(
            name="clinicattendance",
            unique_together={("clinic", "student", "expected_clinic_date")},
        ),
        # ëª¨ë¸ ì˜µì…˜ ë³€ê²½
        migrations.AlterModelOptions(
            name="clinicattendance",
            options={
                "ordering": ["-expected_clinic_date", "-created_at"],
                "verbose_name": "í´ë¦¬ë‹‰ ì¶œì„",
                "verbose_name_plural": "í´ë¦¬ë‹‰ ì¶œì„",
            },
        ),
        # ìƒˆ ì¸ë±ìŠ¤ë“¤ ì¶”ê°€
        migrations.AddIndex(
            model_name="clinicattendance",
            index=models.Index(
                fields=["student", "-expected_clinic_date"],
                name="core_clinic_student_8324bf_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="clinicattendance",
            index=models.Index(
                fields=["clinic", "-expected_clinic_date"],
                name="core_clinic_clinic__80296d_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="clinicattendance",
            index=models.Index(
                fields=["expected_clinic_date"], name="core_clinic_expecte_f6f35d_idx"
            ),
        ),
    ]
