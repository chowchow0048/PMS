# Generated by Django 5.0.3 on 2025-08-06 00:14

from django.db import migrations, models


def cleanup_duplicate_attendance_before_constraint(apps, schema_editor):
    """
    unique ì œì•½ ì¡°ê±´ ìƒì„± ì „ì— ì¤‘ë³µ ë°ì´í„°ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.
    Railway ì½˜ì†” ì ‘ì† ë¶ˆê°€ ì‹œë¥¼ ìœ„í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ ì •ë¦¬ ë¡œì§
    """
    ClinicAttendance = apps.get_model('core', 'ClinicAttendance')
    
    print("ğŸ” [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ì¶œì„ ë°ì´í„° ì •ë¦¬ ì‹œì‘...")
    
    # 1. ë¹„í™œì„±í™”ëœ ë°ì´í„° ì‚­ì œ
    inactive_count = ClinicAttendance.objects.filter(is_active=False).count()
    if inactive_count > 0:
        print(f"ğŸ“Š [ë§ˆì´ê·¸ë ˆì´ì…˜] ë¹„í™œì„±í™”ëœ ë°ì´í„° {inactive_count}ê°œ ì‚­ì œ ì¤‘...")
        ClinicAttendance.objects.filter(is_active=False).delete()
    
    # 2. ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ - SQL ì§ì ‘ ì‹¤í–‰
    from django.db import connection
    with connection.cursor() as cursor:
        # ì¤‘ë³µ ë°ì´í„° í™•ì¸
        cursor.execute("""
            SELECT 
                clinic_id, 
                student_id, 
                expected_clinic_date,
                COUNT(*) as count
            FROM core_clinicattendance 
            GROUP BY clinic_id, student_id, expected_clinic_date
            HAVING COUNT(*) > 1
            LIMIT 5
        """)
        duplicates = cursor.fetchall()
        
        if duplicates:
            print(f"ğŸ“Š [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„° ë°œê²¬: {len(duplicates)}ê°œ ê·¸ë£¹")
            for clinic_id, student_id, date, count in duplicates:
                print(f"  - í´ë¦¬ë‹‰ {clinic_id}, í•™ìƒ {student_id}, ë‚ ì§œ {date}: {count}ê°œ")
        
        # ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ (ê°€ì¥ ìµœê·¼ ê²ƒë§Œ ìœ ì§€)
        cursor.execute("""
            WITH duplicate_rows AS (
                SELECT id,
                       ROW_NUMBER() OVER (
                           PARTITION BY clinic_id, student_id, expected_clinic_date 
                           ORDER BY created_at DESC
                       ) as rn
                FROM core_clinicattendance
            )
            DELETE FROM core_clinicattendance 
            WHERE id IN (
                SELECT id FROM duplicate_rows WHERE rn > 1
            )
        """)
        deleted_count = cursor.rowcount
        
        if deleted_count > 0:
            print(f"âœ… [ë§ˆì´ê·¸ë ˆì´ì…˜] {deleted_count}ê°œ ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ")
        else:
            print("âœ… [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤")
    
    print("ğŸ‰ [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!")


def reverse_cleanup_duplicate_attendance(apps, schema_editor):
    """ì—­ë°©í–¥ ë§ˆì´ê·¸ë ˆì´ì…˜ - ì‹¤ì œë¡œëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ ì¶œë ¥"""
    print("âš ï¸ [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0030_alter_clinicattendance_date"),
    ]

    operations = [
        # ğŸš¨ ì¤‘ìš”: unique ì œì•½ ì¡°ê±´ ìƒì„± ì „ì— ì¤‘ë³µ ë°ì´í„°ë¥¼ ë¨¼ì € ì •ë¦¬
        migrations.RunPython(
            cleanup_duplicate_attendance_before_constraint,
            reverse_cleanup_duplicate_attendance,
        ),
        # ë¨¼ì € ê¸°ì¡´ unique_together ì œê±° (date í•„ë“œê°€ í¬í•¨ë˜ì–´ ìˆìŒ)
        migrations.AlterUniqueTogether(
            name="clinicattendance",
            unique_together=set(),
        ),
        # ê¸°ì¡´ ì¸ë±ìŠ¤ë“¤ ì œê±°
        migrations.RemoveIndex(
            model_name="clinicattendance",
            name="core_clinic_student_ebaed1_idx",
        ),
        migrations.RemoveIndex(
            model_name="clinicattendance",
            name="core_clinic_clinic__529a2b_idx",
        ),
        # ê¸°ì¡´ date í•„ë“œ ì œê±°
        migrations.RemoveField(
            model_name="clinicattendance",
            name="date",
        ),
        # ìƒˆ í•„ë“œë“¤ ì¶”ê°€
        migrations.AddField(
            model_name="clinicattendance",
            name="actual_attendance_date",
            field=models.DateField(
                blank=True,
                help_text="ì‹¤ì œë¡œ ì¶œì„ì„ ì²´í¬í•œ ë‚ ì§œ. ì¶œì„ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ë•Œë§Œ ì„¤ì •ë¨.",
                null=True,
                verbose_name="ì‹¤ì œ ì¶œì„ ì²´í¬ ë‚ ì§œ",
            ),
        ),
        migrations.AddField(
            model_name="clinicattendance",
            name="expected_clinic_date",
            field=models.DateField(
                default="2025-01-01",
                help_text="í•´ë‹¹ ì£¼ì—ì„œ í´ë¦¬ë‹‰ì´ ì—´ë¦¬ëŠ” ì˜ˆìƒ ë‚ ì§œ (í´ë¦¬ë‹‰ ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë¨)",
                verbose_name="ì˜ˆìƒ í´ë¦¬ë‹‰ ë‚ ì§œ",
            ),
        ),
        migrations.AddField(
            model_name="clinicattendance",
            name="reservation_date",
            field=models.DateField(
                default="2025-01-01",
                help_text="í´ë¦¬ë‹‰ ì˜ˆì•½ì„ ìƒì„±í•œ ë‚ ì§œ (ì–¸ì œ ì˜ˆì•½í–ˆëŠ”ì§€)",
                verbose_name="ì˜ˆì•½ ìƒì„± ë‚ ì§œ",
            ),
        ),
        # ìƒˆ í•„ë“œë“¤ì´ ì¶”ê°€ëœ í›„ì— unique_together ë³€ê²½
        migrations.AlterUniqueTogether(
            name="clinicattendance",
            unique_together={("clinic", "student", "expected_clinic_date")},
        ),
        # ëª¨ë¸ ì˜µì…˜ ë³€ê²½
        migrations.AlterModelOptions(
            name="clinicattendance",
            options={
                "ordering": ["-expected_clinic_date", "-created_at"],
                "verbose_name": "í´ë¦¬ë‹‰ ì¶œì„",
                "verbose_name_plural": "í´ë¦¬ë‹‰ ì¶œì„",
            },
        ),
        # ìƒˆ ì¸ë±ìŠ¤ë“¤ ì¶”ê°€
        migrations.AddIndex(
            model_name="clinicattendance",
            index=models.Index(
                fields=["student", "-expected_clinic_date"],
                name="core_clinic_student_8324bf_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="clinicattendance",
            index=models.Index(
                fields=["clinic", "-expected_clinic_date"],
                name="core_clinic_clinic__80296d_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="clinicattendance",
            index=models.Index(
                fields=["expected_clinic_date"], name="core_clinic_expecte_f6f35d_idx"
            ),
        ),
    ]
