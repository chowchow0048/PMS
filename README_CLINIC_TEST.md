# 보충 예약 시스템 부하 테스트

실제 사용 상황과 유사한 동시성을 갖춘 보충 예약 시스템의 부하 테스트 도구입니다.

## 📋 테스트 개요

이 테스트는 다음을 시뮬레이션합니다:

- **20명의 학생**이 동시에 로그인
- 각 학생마다 **1~5개의 무작위 클리닉** 예약 시도
- **실제 사용자 행동** 패턴 모방 (랜덤 딜레이 포함)
- **동시성 및 경합 상황** 테스트
- **월요일 클리닉**에 집중된 부하 테스트

## 🚀 빠른 시작

### 1. 간단한 실행 (권장)

```bash
# 프로젝트 루트에서 실행
python run_clinic_test.py
```

이 스크립트는 자동으로 다음을 수행합니다:

- 필요한 패키지 설치 확인
- 백엔드 서버 연결 확인
- 테스트용 클리닉 생성
- 부하 테스트 실행
- 결과 분석

### 2. 수동 실행

#### 2-1. 테스트 환경 준비

```bash
# 1. 필요한 패키지 설치
pip install aiohttp>=3.8.0

# 2. 백엔드 서버 실행 (별도 터미널)
cd backend
python manage.py runserver

# 3. 테스트용 클리닉 생성
python manage.py setup_test_clinics --reset
```

#### 2-2. 부하 테스트 실행

```bash
# 프로젝트 루트에서 실행
python backend/scripts/clinic_reservation_stress_test.py
```

## 📊 테스트 구성

### 생성되는 테스트 데이터

- **학생 계정**: 20개 (`test_student_01` ~ `test_student_20`)
- **강사 계정**: 8개 (`test_teacher_01` ~ `test_teacher_08`)
- **월요일 클리닉**: 8개 (4개 시간대 × 2개 강의실)

### 클리닉 구성

| 시간  | 강의실  | 강사         | 정원 |
| ----- | ------- | ------------ | ---- |
| 18:00 | 1강의실 | 테스트강사01 | 6명  |
| 18:00 | 2강의실 | 테스트강사02 | 6명  |
| 19:00 | 3강의실 | 테스트강사03 | 6명  |
| 19:00 | 4강의실 | 테스트강사04 | 6명  |
| 20:00 | 5강의실 | 테스트강사05 | 6명  |
| 20:00 | 6강의실 | 테스트강사06 | 6명  |
| 21:00 | 7강의실 | 테스트강사07 | 6명  |
| 21:00 | 8강의실 | 테스트강사08 | 6명  |

**총 수용 인원**: 48명 (8개 클리닉 × 6명)

## 🔬 테스트 시나리오

### 동시성 테스트 흐름

1. **계정 생성**: 20명의 테스트 학생 계정 생성 (기존 계정 재사용)

2. **동시 로그인**: 모든 학생이 동시에 로그인하여 토큰 획득

3. **스케줄 조회**: 월요일 클리닉 현황 파악

4. **동시 예약**: 각 학생별로 다음 패턴으로 예약 시도:

   - 1~5개의 무작위 클리닉 선택
   - 예약 시도 간 0.1~2초 랜덤 딜레이
   - 실제 사용자 행동 패턴 모방

5. **결과 분석**: 성공/실패 통계, 응답시간, 오류 분석

### 예상되는 경합 상황

- **정원 초과**: 48명 수용에 20명이 각각 1~5개 예약 시도 (평균 60회 예약 시도)
- **동시 접근**: 같은 클리닉에 여러 학생이 동시 예약 시도
- **Race Condition**: 마지막 자리를 놓고 경쟁하는 상황

## 📈 결과 분석

### 출력되는 메트릭

- **총 소요 시간**: 전체 테스트 실행 시간
- **참가 학생 수**: 실제로 로그인에 성공한 학생 수
- **총 예약 시도**: 모든 학생의 예약 시도 총합
- **성공한 예약**: 실제로 예약된 횟수
- **실패한 예약**: 예약에 실패한 횟수
- **성공률**: 예약 성공 비율
- **평균 응답시간**: API 응답 시간 평균

### 실패 원인 분석

테스트는 다음과 같은 실패 원인들을 분류합니다:

- `occupied`: 정원 초과 (정상적인 경합 상황)
- `이미 해당 클리닉에 예약되어 있습니다`: 중복 예약 시도
- `no_show_blocked`: 노쇼로 인한 예약 제한
- `reservation_closed`: 예약 기간 제한
- 네트워크 오류 등

### 최종 현황

테스트 완료 후 각 클리닉의 최종 예약 현황을 표시:

```
📋 최종 월요일 클리닉 현황:
  • 18:00 - physics1 (1강의실) - 6/6 🔴 마감
  • 18:00 - physics1 (2강의실) - 4/6 🟢 2자리
  • 19:00 - physics1 (3강의실) - 6/6 🔴 마감
  • ...
```

## 📁 생성되는 파일

### `clinic_test.log`

상세한 테스트 실행 로그:

- 각 학생의 로그인 과정
- 개별 예약 시도와 결과
- 상세한 에러 메시지
- 시간별 진행 상황

## ⚙️ 설정 옵션

### Django 관리 명령어 옵션

```bash
# 기본 클리닉 생성
python manage.py setup_test_clinics

# 기존 클리닉 초기화 후 생성
python manage.py setup_test_clinics --reset

# 클리닉 정원 변경 (기본값: 6명)
python manage.py setup_test_clinics --capacity 10
```

### 테스트 스크립트 설정

`backend/scripts/clinic_reservation_stress_test.py` 파일에서 다음 값들을 수정할 수 있습니다:

```python
BASE_URL = "http://localhost:8000/api"  # 백엔드 API URL
NUM_STUDENTS = 20  # 테스트할 학생 수
TARGET_DAY = "mon"  # 테스트할 요일
```

## 🔧 문제 해결

### 일반적인 문제들

1. **서버 연결 실패**

   ```
   ❌ 백엔드 서버 연결 실패
   ```

   - Django 서버가 `http://localhost:8000`에서 실행 중인지 확인
   - 방화벽 설정 확인

2. **클리닉이 없음**

   ```
   ❌ 월요일에 예약 가능한 클리닉이 없습니다
   ```

   - `python manage.py setup_test_clinics --reset` 실행

3. **패키지 설치 오류**

   ```
   ❌ aiohttp 설치 필요
   ```

   - `pip install aiohttp>=3.8.0` 실행

4. **로그인 실패**
   ```
   ❌ 로그인 실패: test_student_01
   ```
   - 데이터베이스 연결 상태 확인
   - Django migrations 실행 확인

### 디버깅 방법

1. **상세 로그 확인**:

   ```bash
   tail -f clinic_test.log
   ```

2. **Django 로그 확인**:

   ```bash
   # Django 서버 실행 시 로그 출력 확인
   python manage.py runserver
   ```

3. **데이터베이스 상태 확인**:
   ```bash
   python manage.py shell
   >>> from core.models import Clinic, User
   >>> Clinic.objects.filter(clinic_day='mon', is_active=True).count()
   >>> User.objects.filter(username__startswith='test_student').count()
   ```

## 📋 요구사항

### 시스템 요구사항

- **Python**: 3.8 이상
- **Django**: 4.x
- **PostgreSQL**: 12 이상
- **메모리**: 최소 2GB RAM (동시 연결 처리용)

### Python 패키지

```
aiohttp>=3.8.0
asyncio (표준 라이브러리)
```

### 백엔드 서버 상태

- Django 서버가 `http://localhost:8000`에서 실행 중
- 데이터베이스 연결 정상
- 다음 API 엔드포인트들이 정상 작동:
  - `/api/auth/register/`
  - `/api/auth/login/`
  - `/api/clinics/weekly-schedule/`
  - `/api/clinics/reserve/`

## 🎯 활용 방안

### 성능 테스트

- **응답시간 모니터링**: API 응답시간 측정
- **동시성 검증**: 경합 상황에서의 데이터 일관성 확인
- **부하 한계 측정**: 시스템이 처리할 수 있는 최대 동시 사용자 수

### 비즈니스 로직 검증

- **선착순 시스템**: 정원 초과 시 올바른 처리
- **중복 예약 방지**: 같은 학생의 중복 예약 차단
- **노쇼 관리**: 노쇼 횟수에 따른 예약 제한

### 개발/배포 검증

- **코드 변경 후 영향도 측정**
- **배포 전 시스템 안정성 확인**
- **데이터베이스 성능 최적화 효과 측정**

## 📞 문의 및 개선

테스트 관련 문의사항이나 개선 제안은 다음을 통해 연락해주세요:

- 테스트 스크립트 수정: `backend/scripts/clinic_reservation_stress_test.py`
- Django 명령어 수정: `backend/core/management/commands/setup_test_clinics.py`
- 실행 스크립트 수정: `run_clinic_test.py`

---

**⚠️ 주의사항**: 이 테스트는 개발/테스트 환경에서만 사용하세요. 프로덕션 환경에서는 실행하지 마세요.
